cmake_minimum_required(VERSION 3.16)

project(yolo_fast LANGUAGES CXX)

# 设置C++标准
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# 统一设置 CUDA 路径
set(CUDA_INCLUDE_DIRS /usr/local/cuda/include)
set(CUDA_LIBRARIES /usr/local/cuda/lib64/libcudart.so)

# 设置SimpleCudaToolkits的路径
set(SIMPLE_CUDA_TOOLKITS_PATH /opt/SimpleCudaToolkits)
set(SIMPLE_CUDA_TOOLKITS_INC ${SIMPLE_CUDA_TOOLKITS_PATH}/include)
set(SIMPLE_CUDA_TOOLKITS_LIB ${SIMPLE_CUDA_TOOLKITS_PATH}/lib)

# 检查系统架构以区分 TensorRT 的设置
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64")  # Jetson 平台（ARM64 架构）
    message(STATUS "Configuring for Jetson platform (ARM64)")

    # 使用系统路径查找 TensorRT
    find_path(TENSORRT_INCLUDE_DIR NvInfer.h
            HINTS /usr/include /usr/local/include
    )

    find_library(NVINFER_LIB nvinfer
            HINTS /usr/lib/aarch64-linux-gnu /usr/local/lib
    )

    find_library(NVPARSERS_LIB nvparsers
            HINTS /usr/lib/aarch64-linux-gnu /usr/local/lib
    )

    find_library(NVONNXPARSER_LIB nvonnxparser
            HINTS /usr/lib/aarch64-linux-gnu /usr/local/lib
    )

    set(TENSORRT_LIBS
            ${NVINFER_LIB}
            ${NVPARSERS_LIB}
            ${NVONNXPARSER_LIB}
    )

else()  # x86 平台
    message(STATUS "Configuring for x86 platform")

    # 设置TensorRT的路径, 使用相对路径
    set(TENSORRT_INCLUDE_DIRS /opt/tensorrt/include)
    set(TENSORRT_LIBRARIES /opt/tensorrt/lib)
    set(TENSORRT_LIBS
            ${TENSORRT_LIBRARIES}/libnvinfer.so
            ${TENSORRT_LIBRARIES}/libnvonnxparser.so
    )
endif()

# 查找 OpenCV
find_package(OpenCV REQUIRED)

# 查找所有 common 目录下的子目录源文件
file(GLOB_RECURSE SOURCE_FILES "common/*.cpp")

# 设置输出目录
set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib)

# 创建共享库(.so)
add_library(yolo_fast_shared SHARED ${SOURCE_FILES})

# 创建静态库(.a)
add_library(yolo_fast_static STATIC ${SOURCE_FILES})

# 包含目录设置
target_include_directories(yolo_fast_shared PRIVATE
        ${CUDA_INCLUDE_DIRS}
        ${PROJECT_SOURCE_DIR}
        ${SIMPLE_CUDA_TOOLKITS_INC}
        ${TENSORRT_INCLUDE_DIRS}
        ${OpenCV_INCLUDE_DIRS}
)

target_include_directories(yolo_fast_static PRIVATE
        ${CUDA_INCLUDE_DIRS}
        ${PROJECT_SOURCE_DIR}
        ${SIMPLE_CUDA_TOOLKITS_INC}
        ${TENSORRT_INCLUDE_DIRS}
        ${OpenCV_INCLUDE_DIRS}
)

# 链接库
target_link_libraries(yolo_fast_shared PRIVATE
        ${OpenCV_LIBRARIES}
        ${TENSORRT_LIBS}
        ${SIMPLE_CUDA_TOOLKITS_LIB}/libsimplecuda.a
        ${CUDA_LIBRARIES}
)

target_link_libraries(yolo_fast_static PRIVATE
        ${OpenCV_LIBRARIES}
        ${TENSORRT_LIBS}
        ${SIMPLE_CUDA_TOOLKITS_LIB}/libsimplecuda.a
        ${CUDA_LIBRARIES}
)

# 安装规则（可选）
install(TARGETS yolo_fast_shared yolo_fast_static
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib)
